import re
import json
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy.future import select
import models
# ==========================================
# 1. å®šä¹‰é«˜é¢‘è§„åˆ™åº“ (åŸæœ¬åœ¨ rule_service.py)
# ==========================================
_RULES_CACHE = []

async def load_rules_from_db(db: AsyncSession):
    """
    ã€çƒ­æ›´æ–°ã€‘ä»æ•°æ®åº“è¯»å–æ‰€æœ‰å¯ç”¨è§„åˆ™ï¼Œç¼–è¯‘æ­£åˆ™ï¼Œæ›´æ–°åˆ°å†…å­˜ç¼“å­˜ã€‚
    æ­¤å‡½æ•°åº”åœ¨ç³»ç»Ÿå¯åŠ¨æ—¶è°ƒç”¨ï¼Œä»¥åŠç®¡ç†å‘˜ä¿®æ”¹è§„åˆ™åè°ƒç”¨ã€‚
    """
    global _RULES_CACHE
    print("ğŸ”„ æ­£åœ¨ä»æ•°æ®åº“é‡æ–°åŠ è½½é«˜é¢‘è§„åˆ™åº“...")
    
    try:
        result = await db.execute(select(models.Rule).filter(models.Rule.active == True))
        rules_db = result.scalars().all()
        
        new_cache = []
        for r in rules_db:
            try:
                # æ•°æ®åº“å­˜çš„æ˜¯ JSON å­—ç¬¦ä¸² '["a", "b"]' -> è§£æä¸º Python list
                pattern_strs = json.loads(r.patterns)
                if not isinstance(pattern_strs, list):
                    pattern_strs = [str(pattern_strs)]
                
                # é¢„ç¼–è¯‘æ­£åˆ™ï¼Œå¿½ç•¥å¤§å°å†™
                compiled_patterns = [re.compile(p, re.IGNORECASE) for p in pattern_strs]
                
                new_cache.append({
                    "patterns": compiled_patterns,
                    "answer": r.answer,
                    "source": r.source
                })
            except Exception as e:
                print(f"âŒ è§„åˆ™ ID {r.id} åŠ è½½å¤±è´¥: {e}")
                
        _RULES_CACHE = new_cache
        print(f"âœ… è§„åˆ™åº“åŠ è½½å®Œæˆï¼Œå½“å‰ç”Ÿæ•ˆè§„åˆ™æ•°: {len(_RULES_CACHE)}")
        
    except Exception as e:
        print(f"âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: {e}")
        
LEGAL_RULES = [
    (
        [r"å€Ÿæ¬¾.*è¯‰è®¼æ—¶æ•ˆ", r"æ¬ é’±.*å¤šä¹….*èµ·è¯‰"], 
        "æ ¹æ®ã€Šæ°‘æ³•å…¸ã€‹ç¬¬ä¸€ç™¾å…«åå…«æ¡ï¼Œå‘äººæ°‘æ³•é™¢è¯·æ±‚ä¿æŠ¤æ°‘äº‹æƒåˆ©çš„è¯‰è®¼æ—¶æ•ˆæœŸé—´ä¸ºä¸‰å¹´ã€‚è¯‰è®¼æ—¶æ•ˆæœŸé—´è‡ªæƒåˆ©äººçŸ¥é“æˆ–è€…åº”å½“çŸ¥é“æƒåˆ©å—åˆ°æŸå®³ä»¥åŠä¹‰åŠ¡äººä¹‹æ—¥èµ·è®¡ç®—ã€‚",
        "ã€Šæ°‘æ³•å…¸ã€‹ç¬¬ä¸€ç™¾å…«åå…«æ¡"
    ),
    (
        [r"åˆ©æ¯.*ä¸Šé™", r"é«˜åˆ©è´·.*æ ‡å‡†", r"å¹´åˆ©ç‡.*å¤šå°‘"],
        "æ ¹æ®æœ€é«˜äººæ°‘æ³•é™¢è§„å®šï¼Œå€Ÿè´·åŒæ–¹çº¦å®šçš„åˆ©ç‡æœªè¶…è¿‡åˆåŒæˆç«‹æ—¶ä¸€å¹´æœŸè´·æ¬¾å¸‚åœºæŠ¥ä»·åˆ©ç‡ï¼ˆLPRï¼‰å››å€çš„ï¼Œäººæ°‘æ³•é™¢åº”äºˆæ”¯æŒã€‚è¶…è¿‡éƒ¨åˆ†ä¸äºˆä¿æŠ¤ã€‚",
        "æœ€é«˜æ³•ã€Šå…³äºå®¡ç†æ°‘é—´å€Ÿè´·æ¡ˆä»¶é€‚ç”¨æ³•å¾‹è‹¥å¹²é—®é¢˜çš„è§„å®šã€‹"
    ),
    (
        [r"å®¢æœ.*ç”µè¯", r"è”ç³».*ç®¡ç†å‘˜", r"äººå·¥.*æœåŠ¡"],
        "æˆ‘ä»¬çš„æ³•å¾‹æ´åŠ©çƒ­çº¿æ˜¯ï¼š400-888-8888ã€‚å·¥ä½œæ—¶é—´ï¼šå‘¨ä¸€è‡³å‘¨äº” 9:00-18:00ã€‚",
        "å¹³å°æœåŠ¡æŒ‡å—"
    ),
    (
        [r"æ€äºº.*åˆ¤å‡ å¹´", r"æ•…æ„æ€äºº.*åˆ‘æœŸ"],
        "æ ¹æ®ã€Šåˆ‘æ³•ã€‹ç¬¬äºŒç™¾ä¸‰åäºŒæ¡ï¼Œæ•…æ„æ€äººçš„ï¼Œå¤„æ­»åˆ‘ã€æ— æœŸå¾’åˆ‘æˆ–è€…åå¹´ä»¥ä¸Šæœ‰æœŸå¾’åˆ‘ï¼›æƒ…èŠ‚è¾ƒè½»çš„ï¼Œå¤„ä¸‰å¹´ä»¥ä¸Šåå¹´ä»¥ä¸‹æœ‰æœŸå¾’åˆ‘ã€‚",
        "ã€Šåˆ‘æ³•ã€‹ç¬¬äºŒç™¾ä¸‰åäºŒæ¡"
    )
]

# ==========================================
# 2. çŸ¥è¯†åº“åˆå§‹åŒ–é€»è¾‘ (åŸæœ¬åœ¨ rag_service.py)
# ==========================================

def add_legal_document(content, source):
    """
    å‡è®¾è¿™æ˜¯ä½ åŸæœ‰çš„å…¥åº“å‡½æ•°ï¼Œç”¨äºå°†æ–‡æœ¬å‘é‡åŒ–å¹¶å­˜å…¥æ•°æ®åº“
    """
    # ç¤ºä¾‹ä¼ªä»£ç ï¼šcollection.add(documents=[content], metadatas=[{"source": source}])
    print(f"æˆåŠŸå…¥åº“ -> æ¥æº: {source} | å†…å®¹æ‘˜è¦: {content[:20]}...")

def init_knowledge_base():
    """
    ä¿®æ”¹åçš„ init éƒ¨åˆ†ï¼š
    åœ¨åˆå§‹åŒ–å‘é‡åº“æ—¶ï¼Œå¾ªç¯å°† LEGAL_RULES é‡Œçš„å†…å®¹ä¹Ÿå­˜è¿›å»
    """
    # æ¨¡æ‹Ÿæ£€æŸ¥æ•°æ®åº“æ˜¯å¦ä¸ºç©ºï¼Œé˜²æ­¢é‡å¤å¯¼å…¥
    # if collection.count() == 0: 
    
    print("å¼€å§‹åˆå§‹åŒ–æ³•å¾‹çŸ¥è¯†åº“...")
    
    # --- åŸæœ‰çš„æ³•å¾‹æ¡æ–‡å¯¼å…¥é€»è¾‘ (æ­¤å¤„çœç•¥å…·ä½“å®ç°) ---
    # import_existing_laws() 

    # --- æ–°å¢ï¼šæŠŠè§„åˆ™åº“ä¹Ÿå˜æˆ AI çš„çŸ¥è¯† ---
    # è¿™æ ·å³ä½¿æ­£åˆ™å¼•æ“æ²¡åŒ¹é…åˆ°ï¼ˆæ¯”å¦‚ç”¨æˆ·é—®æ³•å¾ˆæ€ªï¼‰ï¼ŒAI æ£€ç´¢ RAG ä¹Ÿèƒ½æœåˆ°è¿™äº›æ ‡å‡†ç­”æ¡ˆ
    for patterns, answer, source in LEGAL_RULES:
        # ç»„åˆæˆä¸€æ®µè¯­ä¹‰å®Œæ•´çš„æ–‡æœ¬å­˜å…¥å‘é‡åº“
        # æˆ‘ä»¬å– patterns[0] ä½œä¸ºå…¸å‹é—®é¢˜æè¿°ï¼Œé…åˆæ ‡å‡†ç­”æ¡ˆ
        content = f"é—®é¢˜å…³é”®è¯ï¼š{patterns[0]}ã€‚æ ‡å‡†ç­”æ¡ˆï¼š{answer}"
        
        # è°ƒç”¨å…¥åº“å‡½æ•°ï¼Œæ ‡è®°æ¥æºä¸ºâ€œè§„åˆ™åº“â€
        add_legal_document(content, f"è§„åˆ™åº“-{source}")

    print("æ³•å¾‹çŸ¥è¯†åº“ + è§„åˆ™åº“ åˆå§‹åŒ–å®Œæˆï¼")

# ==========================================
# 3. è§„åˆ™åŒ¹é…å¼•æ“ (åŸæœ¬çš„ check_rules)
# ==========================================

def check_rules(user_query: str):
    """
    è§„åˆ™åŒ¹é…å¼•æ“ï¼šè¿”å› (matched_content, source) æˆ– (None, None)
    """
    for patterns, answer, source in LEGAL_RULES:
        for pattern in patterns:
            # ä½¿ç”¨ regex è¿›è¡Œæ¨¡ç³ŠåŒ¹é…ï¼ŒIGNORECASE å¿½ç•¥å¤§å°å†™
            if re.search(pattern, user_query, re.IGNORECASE):
                return answer, source
    return None, None

# --- æµ‹è¯•è¿è¡Œ ---
if __name__ == "__main__":
    # æ‰§è¡Œåˆå§‹åŒ–ï¼ˆå°†è§„åˆ™å­˜å…¥å‘é‡åº“ï¼‰
    init_knowledge_base()
    
    # æµ‹è¯•æ­£åˆ™åŒ¹é…
    test_query = "è¯·é—®æ¬ é’±ä¸è¿˜å¤šä¹…å¯ä»¥èµ·è¯‰ï¼Ÿ"
    ans, src = check_rules(test_query)
    if ans:
        print(f"\n[åŒ¹é…æˆåŠŸ] æ¥æºï¼š{src}\nå›ç­”ï¼š{ans}")